STRCFLAGS = \
	-la stratego-lib \
	-la strc \
	-I ../syntax \
	-I ../trans \
	-I ../runtime \
	--format-check 0 \
	-O 0 \
	-Xcc -O0

ASTRS=$(wildcard *.astr)

RUNTESTS = $(ASTRS:.astr=)

EXTRA_DIST =\
  $(RUNTESTS:=.astr) \
  Stratego-Attributes.testsuite \
  test-aster.str test-aster.meta test-attributes.astr

check : Stratego-Attributes.runtestsuite \
        test-aster test-aster.run \
        $(RUNTESTS:=.str) $(RUNTESTS) \
        $(RUNTESTS:=.run)

# check-prepare : $(RUNTESTS:=.str)
#	$(MAKE) -j3 $(RUNTESTS)

CLEANFILES = $(tests) $(ASTRS:.astr=.str)

clean :
	rm -f $(RUNTESTS) $(RUNTESTS:=.str) test-attributes.str

%.str : %.astr $(top_srcdir)/trans/aster
	$(top_srcdir)/trans/aster -i $< -o $@ --trace --verbose 2

%$(EXEEXT) : %.str
	strc -i $< -m main-`basename $*` $(STRCFLAGS) >/dev/null

$(top_srcdir)/trans/aster$(EXEEXT) :
	$(MAKE) -C $(top_srcdir)/trans aster$(EXEEXT)

test-aster : test-attributes.str

test-attributes.str : test-attributes.astr $(top_srcdir)/trans/aster
	$(top_srcdir)/trans/aster -i $< -o $@ --verbose 2

%.run : %
	@echo
	@echo ==== `basename $@ .run` ====
	@./$* --verbose 2

%.runtestsuite : %.testsuite
	parse-unit --no-heuristic-filters -i $< -p ../syntax/Stratego-Attributes.tbl
